# Chainlink External Initiator Connected to Conflux Network
How to connect trigger a Chainlink run from a Conflux Network transaction using an External Initiator (EI).

### Setting up the Chainlink Node
Start a Chainlink node: https://docs.chain.link/docs/running-a-chainlink-node

Sample `.env` file for Chainlink Node:
```
ROOT=/chainlink
LOG_LEVEL=debug
ETH_CHAIN_ID=3
MIN_OUTGOING_CONFIRMATIONS=2
LINK_CONTRACT_ADDRESS=0x20fe562d797a42dcb3399062ae9546cd06f63280
CHAINLINK_TLS_PORT=0
SECURE_COOKIES=false
ALLOW_ORIGINS=*
DATABASE_TIMEOUT=0
DATABASE_URL=DATABASE_URL=postgresql://$USERNAME:$PASSWORD@$SERVER:$PORT/$DATABASE
ETH_DISABLED=true
FEATURE_EXTERNAL_INITIATORS=true
CHAINLINK_DEV=true
```

Command to start Chainlink node in docker container:
```
cd ~/.chainlink-ropsten && docker run -p 6688:6688 -v ~/.chainlink-ropsten:/chainlink -it --env-file=.env smartcontract/chainlink local n
```

### Setting up the External Initiator
Create a `.env` file in the `external-initiator` folder with the following contents:

```
EI_DATABASEURL=postgresql://$USERNAME:$PASSWORD@$SERVER:$PORT/$DATABASE
EI_CHAINLINKURL=http://localhost:6688
EI_IC_ACCESSKEY=<INSERT KEY>
EI_IC_SECRET=<INSERT KEY>
EI_CI_ACCESSKEY=<INSERT KEY>
EI_CI_SECRET=<INSERT KEY>
```

The 4 keys in the `external-initiator/.env` file are generated by the Chainlink node with the following process. [Link](https://docs.chain.link/docs/miscellaneous) to more Chainlink/Docker documentation.

1. Use `docker ps` and obtain the container ID for the Chainlink node. To access the command line within the container, use `docker exec -it <containerID> /bin/bash`.
1. Once inside the container, log in using `chainlink admin login` and the username/password from when the container is created.
1. To create the keys, `chainlink initiators create <NAME> <URL>`. Note that in this case the url is `http://172.17.0.1:8080/jobs` to access the locally run external-initiator using the docker container gateway. (otherwise, they are on two different networks). The 4 keys are generated in the same order as listed above.

The external initiator can be started up using:

```
./external-initiator "{\"name\":\"cfx-testnet\",\"type\":\"conflux\",\"url\":\"http://testnet-jsonrpc.conflux-chain.org:12537\"}" --chainlinkurl "http://localhost:6688/"
```

### Connecting the EI to Conflux Network and the Chainlink Node
Job spec for Chainlink node to start the EI to connect to Conflux Network:
```
{
  "initiators": [
    {
      "type": "external",
      "params": {
        "name": "cfx",
        "body": {
          "endpoint": "cfx-testnet",
          "addresses": ["0x8aa73841e0a0e6e816b2c66c9c5ed1e144ad8cbb"]
        }
      }
    }
  ],
  "tasks": [
    {"type": "noop"}
  ]
}

```
The address is the same as the address for the deployed Conflux Network smart contract.


### Resources:
- External Initiators for Conflux: https://github.com/Conflux-Network-Global/external-initiator
- Chainlink job specifications: https://docs.chain.link/docs/job-specifications
- Chainlink built-in adapters: https://docs.chain.link/docs/adapters
- Chainlink initiators: https://docs.chain.link/docs/initiators
- More advanced demo code: https://github.com/Conflux-Network-Global/demo-cfx-chainlink
